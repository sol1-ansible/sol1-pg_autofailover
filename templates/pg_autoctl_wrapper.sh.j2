#!/bin/bash
# pg_autoctl wrapper script for simplified command execution
# Generated by Ansible - do not edit manually

PGDATA="{{ pg_autofailover_node_pgdata }}"
MONITOR_URI="{{ pg_autofailover_node_monitor_uri }}"
PG_USER="{{ pg_autofailover_service_user }}"

# Helper function to run commands as postgres user
run_as_postgres() {
    if [ "$(whoami)" = "$PG_USER" ]; then
        "$@"
    else
        sudo -u "$PG_USER" "$@"
    fi
}

# Show cluster state
pg_autoctl_show_state() {
    run_as_postgres pg_autoctl show state \
        --pgdata "$PGDATA" \
        --monitor "$MONITOR_URI"
}

# Perform switchover
pg_autoctl_switchover() {
    run_as_postgres pg_autoctl perform switchover \
        --monitor "$MONITOR_URI"
}

# Perform failover
pg_autoctl_failover() {
    run_as_postgres pg_autoctl perform failover \
        --monitor "$MONITOR_URI"
}

# Show current node status
pg_autoctl_status() {
    run_as_postgres pg_autoctl show state \
        --pgdata "$PGDATA"
}

# Show configuration
pg_autoctl_config() {
    run_as_postgres pg_autoctl config get \
        --pgdata "$PGDATA" \
        "$@"
}

# Enable maintenance
pg_autoctl_enable_maintenance() {
    run_as_postgres pg_autoctl enable maintenance \
        --pgdata "$PGDATA"
}

# Disable maintenance
pg_autoctl_disable_maintenance() {
    run_as_postgres pg_autoctl disable maintenance \
        --pgdata "$PGDATA"
}

# Show help
pg_autoctl_help() {
    cat <<EOF
pg_autoctl Wrapper Commands:

  pg_autoctl_show_state          Show cluster state from monitor
  pg_autoctl_switchover          Perform a coordinated switchover
  pg_autoctl_failover            Perform a failover
  pg_autoctl_status              Show current node status
  pg_autoctl_config [setting]    Show configuration setting(s)
  pg_autoctl_enable_maintenance  Enable maintenance mode
  pg_autoctl_disable_maintenance Disable maintenance mode
  pg_autoctl_help                Show this help message

Configuration:
  PGDATA:      $PGDATA
  MONITOR_URI: $MONITOR_URI
  PG_USER:     $PG_USER

For full pg_autoctl documentation, run: pg_autoctl --help
EOF
}

# If script is sourced, export functions; if executed, run command
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    # Script is being executed directly
    if [ $# -eq 0 ]; then
        pg_autoctl_help
    else
        # Execute the function passed as argument
        "$@"
    fi
fi
